// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
let tg = null;
try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram
    if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é
        tg.ready();
        // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();
        
        console.log("Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ");
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ WebApp –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ–º–æ–π Telegram
        if (tg.colorScheme === 'dark') {
            document.documentElement.classList.add('dark-theme');
        }
    } else {
        console.warn('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ —Å—Ä–µ–¥—ã Telegram WebApp');
    }
} catch (e) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', e);
}

// –ê—É–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç—ã
const sounds = {
    click: new Audio('https://cdn.freesound.org/previews/220/220206_4100637-lq.mp3'),
    reward: new Audio('https://cdn.freesound.org/previews/341/341695_5858296-lq.mp3'),
    task: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3'),
    box: new Audio('https://cdn.freesound.org/previews/411/411089_5121236-lq.mp3'),
    achievement: new Audio('https://cdn.freesound.org/previews/320/320775_1661766-lq.mp3'),
    levelUp: new Audio('https://cdn.freesound.org/previews/522/522616_2336793-lq.mp3')
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
let settings = {
    soundEnabled: true,
    vibrationEnabled: true,
    userId: null, // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    serverSync: false // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function loadSettings() {
    const savedSettings = localStorage.getItem('minionsGameSettings');
    if (savedSettings) {
        try {
            settings = {...settings, ...JSON.parse(savedSettings)};
            console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", settings);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
        }
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function saveSettings() {
    localStorage.setItem('minionsGameSettings', JSON.stringify(settings));
    console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã", settings);
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞
function playSound(sound) {
    if (settings.soundEnabled && sounds[sound]) {
        sounds[sound].currentTime = 0;
        sounds[sound].play().catch(err => console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', err));
    }
}

// –í–∏–±—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function vibrate(pattern) {
    if (settings.vibrationEnabled && navigator.vibrate) {
        navigator.vibrate(pattern);
    }
}

// –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let gameState = {
    bananas: 0,
    stars: 0,
    level: 1,
    completedTasks: 0,
    openedBoxes: 0,
    totalBananas: 0,
    totalStars: 0,
    activeDays: 1,
    streak: 0,
    lastReward: null,
    invitedFriends: 0,
    lastSaveTime: Date.now(),
    achievements: ['–ù–∞—á–∏–Ω–∞—é—â–∏–π –º–∏–Ω—å–æ–Ω–æ–≤–æ–¥'],
    taskProgress: {
        task1: 0, // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π
        task2: 0, // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–º–∏—É–º-–∫–µ–π—Å–∞
        task3: 0, // –ö–æ—Ä–º–ª–µ–Ω–∏–µ –º–∏–Ω—å–æ–Ω–æ–≤
        task4: 0, // –°–±–æ—Ä 30 –±–∞–Ω–∞–Ω–æ–≤
        task5: 0, // –û—Ç–∫—Ä—ã—Ç–∏–µ 5 –±–æ–∫—Å–æ–≤
        task6: 0, // –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 3 —É—Ä–æ–≤–Ω—è
        task7: 0, // –ü–æ–ª—É—á–µ–Ω–∏–µ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        task8: 0, // –°–µ—Ä–∏—è –≤—Ö–æ–¥–æ–≤ 5 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
        task9: 0, // –°–æ–±—Ä–∞—Ç—å 100 –±–∞–Ω–∞–Ω–æ–≤
        task10: 0 // –ù–∞–∫–æ–ø–∏—Ç—å 20 –∑–≤–µ–∑–¥
    }
};

// –°–µ—Ä–≤–µ—Ä–Ω—ã–π URL –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
const SERVER_URL = 'https://minions-game-server.glitch.me/api';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
async function syncWithServer() {
    if (!settings.serverSync || !settings.userId) return;
    
    try {
        const response = await fetch(`${SERVER_URL}/save-progress`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: settings.userId,
                gameState: gameState
            })
        });
        
        if (response.ok) {
            console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            gameState.lastSaveTime = Date.now();
        } else {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", await response.text());
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
async function loadFromServer() {
    if (!settings.serverSync || !settings.userId) return false;
    
    try {
        const response = await fetch(`${SERVER_URL}/load-progress/${settings.userId}`);
        
        if (response.ok) {
            const data = await response.json();
            if (data && data.gameState) {
                gameState = {...gameState, ...data.gameState};
                console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞");
                return true;
            }
        } else {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:", await response.text());
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", error);
    }
    
    return false;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
function loadGameState() {
    const savedState = localStorage.getItem('minionsGameState');
    if (savedState) {
        try {
            const parsed = JSON.parse(savedState);
            gameState = {...gameState, ...parsed};
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥
            checkDailyLogin();
            
            console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage");
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
        }
    }
    return false;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
function saveGameState() {
    localStorage.setItem('minionsGameState', JSON.stringify(gameState));
    console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage");
    
    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    if (Date.now() - gameState.lastSaveTime > 5 * 60 * 1000) {
        syncWithServer();
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
function checkDailyLogin() {
    const today = new Date().toDateString();
    
    if (gameState.lastReward !== today) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
        document.getElementById('daily-reward-container').style.display = 'block';
        
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥ –±—ã–ª –≤—á–µ—Ä–∞, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–µ—Ä–∏—é
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayString = yesterday.toDateString();
        
        if (gameState.lastReward === yesterdayString) {
            gameState.streak++;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–∏—é –≤—Ö–æ–¥–æ–≤
            if (gameState.streak >= 5 && gameState.taskProgress.task8 < 1) {
                gameState.taskProgress.task8 = 1;
                completeTask(8);
            }
        } else if (gameState.lastReward) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Ä–∏—é, –µ—Å–ª–∏ –±—ã–ª –ø—Ä–æ–ø—É—Å–∫
            gameState.streak = 0;
        }
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π
        gameState.activeDays++;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–µ—Ä–∏–∏
        document.getElementById('streak-count').textContent = gameState.streak;
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É, –µ—Å–ª–∏ —É–∂–µ –∑–∞–±—Ä–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è
        document.getElementById('daily-reward-container').style.display = 'none';
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä–∞–¥—ã
function claimDailyReward() {
    const today = new Date().toDateString();
    
    // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏–Ω—ã —Å–µ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
    let bananaReward = 5 + (gameState.streak * 2);
    let starReward = Math.floor(gameState.streak / 3) + 1;
    
    gameState.bananas += bananaReward;
    gameState.stars += starReward;
    gameState.totalBananas += bananaReward;
    gameState.totalStars += starReward;
    
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –ø–æ–ª—É—á–µ–Ω–∏—è
    gameState.lastReward = today;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –Ω–∞–≥—Ä–∞–¥—ã
    document.getElementById('daily-reward-container').style.display = 'none';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–±–æ—Ä –±–∞–Ω–∞–Ω–æ–≤ –∏ –∑–≤–µ–∑–¥
    checkResourceTasks();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
    document.getElementById('reward-animation').innerHTML = 'üéÅ';
    showPopup(`–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: +${bananaReward} –±–∞–Ω–∞–Ω–æ–≤, +${starReward} –∑–≤–µ–∑–¥!`);
    
    // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –∏ –≤–∏–±—Ä–∞—Ü–∏—è
    playSound('reward');
    vibrate([100, 50, 100]);
    
    // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
    createConfetti();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    saveGameState();
    
    console.log(`–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: +${bananaReward} –±–∞–Ω–∞–Ω–æ–≤, +${starReward} –∑–≤–µ–∑–¥`);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init() {
    console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('splash-screen').style.display = 'flex';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    loadSettings();
    
    // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram, –ø–æ–ª—É—á–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        settings.userId = user.id.toString();
        document.getElementById('user-name').textContent = user.username || '–ò–≥—Ä–æ–∫';
        
        // –í–∫–ª—é—á–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
        settings.serverSync = true;
        saveSettings();
        
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        const serverLoaded = await loadFromServer();
        
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–±—É–µ–º –∏–∑ localStorage
        if (!serverLoaded) {
            loadGameState();
        }
    } else {
        document.getElementById('user-name').textContent = '–ò–≥—Ä–æ–∫';
        loadGameState();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞–Ω–∏–π
    updateTaskProgress();
    
    // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    setTimeout(function() {
        document.getElementById('splash-screen').style.opacity = 0;
        setTimeout(function() {
            document.getElementById('splash-screen').style.display = 'none';
        }, 500);
        
        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–≤—É–∫
        playSound('task');
    }, 1500);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä–∞–¥—ã
    document.getElementById('daily-reward-btn').addEventListener('click', claimDailyReward);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const sectionId = this.getAttribute('data-section');
            if (sectionId) {
                playSound('click');
                vibrate(30);
                showSection(sectionId);
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById('sound-toggle').addEventListener('click', function() {
        settings.soundEnabled = !settings.soundEnabled;
        this.innerHTML = settings.soundEnabled ? 'üîä' : 'üîá';
        saveSettings();
        if (settings.soundEnabled) playSound('click');
    });
    
    document.getElementById('vibration-toggle').addEventListener('click', function() {
        settings.vibrationEnabled = !settings.vibrationEnabled;
        this.innerHTML = settings.vibrationEnabled ? 'üì≥' : 'üì¥';
        saveSettings();
        if (settings.vibrationEnabled) vibrate(50);
        if (settings.soundEnabled) playSound('click');
    });
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById('sound-toggle').innerHTML = settings.soundEnabled ? 'üîä' : 'üîá';
    document.getElementById('vibration-toggle').innerHTML = settings.vibrationEnabled ? 'üì≥' : 'üì¥';
    
    console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
function checkResourceTasks() {
    // –ó–∞–¥–∞–Ω–∏–µ 4: –°–æ–±–µ—Ä–∏ 30 –±–∞–Ω–∞–Ω–æ–≤
    if (gameState.totalBananas >= 30 && gameState.taskProgress.task4 < 1) {
        gameState.taskProgress.task4 = 1;
        completeTask(4);
    }
    
    // –ó–∞–¥–∞–Ω–∏–µ 9: –°–æ–±–µ—Ä–∏ 100 –±–∞–Ω–∞–Ω–æ–≤
    if (gameState.totalBananas >= 100 && gameState.taskProgress.task9 < 1) {
        gameState.taskProgress.task9 = 1;
        completeTask(9);
    }
    
    // –ó–∞–¥–∞–Ω–∏–µ 10: –ù–∞–∫–æ–ø–∏ 20 –∑–≤–µ–∑–¥
    if (gameState.totalStars >= 20 && gameState.taskProgress.task10 < 1) {
        gameState.taskProgress.task10 = 1;
        completeTask(10);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
    document.getElementById('bananas').textContent = gameState.bananas;
    document.getElementById('stars').textContent = gameState.stars;
    document.getElementById('level').textContent = gameState.level;
    document.getElementById('profile-level').textContent = gameState.level;
    document.getElementById('total-bananas').textContent = gameState.totalBananas;
    document.getElementById('total-stars').textContent = gameState.totalStars;
    document.getElementById('completed-tasks').textContent = gameState.completedTasks;
    document.getElementById('opened-boxes').textContent = gameState.openedBoxes;
    document.getElementById('invited-friends').textContent = gameState.invitedFriends;
    document.getElementById('active-days').textContent = gameState.activeDays;
    
    updateAchievements();
    checkResourceTasks();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞–Ω–∏–π
function updateTaskProgress() {
    // –ó–∞–¥–∞–Ω–∏–µ 1: –ü—Ä–∏–≥–ª–∞—Å–∏ 10 –¥—Ä—É–∑–µ–π
    updateTaskProgressUI(1, gameState.taskProgress.task1, 10);
    
    // –ó–∞–¥–∞–Ω–∏–µ 2: –û—Ç–∫—Ä–æ–π –ø—Ä–µ–º–∏—É–º-–∫–µ–π—Å
    updateTaskProgressUI(2, gameState.taskProgress.task2, 1);
    
    // –ó–∞–¥–∞–Ω–∏–µ 3: –ù–∞–∫–æ—Ä–º–∏ 5 –º–∏–Ω—å–æ–Ω–æ–≤
    updateTaskProgressUI(3, gameState.taskProgress.task3, 5);
    
    // –ó–∞–¥–∞–Ω–∏–µ 4: –°–æ–±–µ—Ä–∏ 30 –±–∞–Ω–∞–Ω–æ–≤
    updateTaskProgressUI(4, Math.min(gameState.totalBananas, 30), 30);
    
    // –ó–∞–¥–∞–Ω–∏–µ 5: –û—Ç–∫—Ä–æ–π 5 –±–æ–∫—Å–æ–≤
    updateTaskProgressUI(5, Math.min(gameState.openedBoxes, 5), 5);
    
    // –ó–∞–¥–∞–Ω–∏–µ 6: –î–æ—Å—Ç–∏–≥–Ω–∏ 3 —É—Ä–æ–≤–Ω—è
    updateTaskProgressUI(6, Math.min(gameState.level, 3), 3);
    
    // –ó–∞–¥–∞–Ω–∏–µ 7: –ü–æ–ª—É—á–∏ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    updateTaskProgressUI(7, Math.min(gameState.achievements.length, 5), 5);
    
    // –ó–∞–¥–∞–Ω–∏–µ 8: –°–µ—Ä–∏—è –≤—Ö–æ–¥–æ–≤ 5 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
    updateTaskProgressUI(8, Math.min(gameState.streak, 5), 5);
    
    // –ó–∞–¥–∞–Ω–∏–µ 9: –°–æ–±–µ—Ä–∏ 100 –±–∞–Ω–∞–Ω–æ–≤
    updateTaskProgressUI(9, Math.min(gameState.totalBananas, 100), 100);
    
    // –ó–∞–¥–∞–Ω–∏–µ 10: –ù–∞–∫–æ–ø–∏ 20 –∑–≤–µ–∑–¥
    updateTaskProgressUI(10, Math.min(gameState.totalStars, 20), 20);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞–Ω–∏—è
function updateTaskProgressUI(taskId, current, total) {
    const progressBar = document.getElementById(`task${taskId}-progress`);
    const counter = document.getElementById(`task${taskId}-counter`);
    
    if (progressBar && counter) {
        progressBar.style.width = `${(current / total) * 100}%`;
        counter.textContent = `${current}/${total}`;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é
function showSection(sectionId) {
    console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ–∫—Ü–∏—é:", sectionId);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.getElementById('tasks-section').classList.add('hidden-section');
    document.getElementById('tasks-section').classList.remove('active-section');
    
    document.getElementById('boxes-section').classList.add('hidden-section');
    document.getElementById('boxes-section').classList.remove('active-section');
    
    document.getElementById('friends-section').classList.add('hidden-section');
    document.getElementById('friends-section').classList.remove('active-section');
    
    document.getElementById('profile-section').classList.add('hidden-section');
    document.getElementById('profile-section').classList.remove('active-section');
    
    document.getElementById('settings-section').classList.add('hidden-section');
    document.getElementById('settings-section').classList.remove('active-section');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
    document.getElementById(sectionId).classList.remove('hidden-section');
    document.getElementById(sectionId).classList.add('active-section');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å —ç—Ç–æ–π —Å–µ–∫—Ü–∏–µ–π
    const clickedButton = Array.from(menuItems).find(item => {
        return item.getAttribute('data-section') === sectionId;
    });
    
    if (clickedButton) {
        clickedButton.classList.add('active');
    }
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
function completeTask(taskId) {
    console.log("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", taskId);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ —É–∂–µ –∑–∞–¥–∞–Ω–∏–µ
    if (gameState.taskProgress[`task${taskId}`] >= 1) {
        return;
    }
    
    let reward = {};
    
    switch(taskId) {
        case 1: // –ü—Ä–∏–≥–ª–∞—Å–∏ 10 –¥—Ä—É–∑–µ–π
            if (gameState.taskProgress.task1 >= 10) {
                gameState.taskProgress.task1 = 1;
                reward = { type: 'bananas', amount: 100 };
            }
            break;
            
        case 2: // –û—Ç–∫—Ä–æ–π –ø—Ä–µ–º–∏—É–º-–∫–µ–π—Å
            reward = { type: 'bananas', amount: 50 };
            break;
            
        case 3: // –ù–∞–∫–æ—Ä–º–∏ 5 –º–∏–Ω—å–æ–Ω–æ–≤
            if (gameState.taskProgress.task3 >= 5) {
                gameState.taskProgress.task3 = 1;
                reward = { type: 'bananas', amount: 20 };
            }
            break;
            
        case 4: // –°–æ–±–µ—Ä–∏ 30 –±–∞–Ω–∞–Ω–æ–≤
            reward = { type: 'stars', amount: 5 };
            break;
            
        case 5: // –û—Ç–∫—Ä–æ–π 5 –±–æ–∫—Å–æ–≤
            reward = { type: 'stars', amount: 10 };
            break;
            
        case 6: // –î–æ—Å—Ç–∏–≥–Ω–∏ 3 —É—Ä–æ–≤–Ω—è
            reward = { type: 'stars', amount: 15 };
            break;
            
        case 7: // –ü–æ–ª—É—á–∏ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
            reward = { type: 'both', bananas: 50, stars: 5 };
            break;
            
        case 8: // –°–µ—Ä–∏—è –≤—Ö–æ–¥–æ–≤ 5 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
            reward = { type: 'stars', amount: 8 };
            break;
            
        case 9: // –°–æ–±–µ—Ä–∏ 100 –±–∞–Ω–∞–Ω–æ–≤
            reward = { type: 'stars', amount: 10 };
            break;
            
        case 10: // –ù–∞–∫–æ–ø–∏ 20 –∑–≤–µ–∑–¥
            reward = { type: 'bananas', amount: 150 };
            break;
    }
    
    // –û—Ç–º–µ—á–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
    gameState.taskProgress[`task${taskId}`] = 1;
    gameState.completedTasks++;
    
    // –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
    let rewardText = '';
    
    if (reward.type === 'bananas') {
        gameState.bananas += reward.amount;
        gameState.totalBananas += reward.amount;
        rewardText = `–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${reward.amount} –±–∞–Ω–∞–Ω–æ–≤`;
    } else if (reward.type === 'stars') {
        gameState.stars += reward.amount;
        gameState.totalStars += reward.amount;
        rewardText = `–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${reward.amount} –∑–≤–µ–∑–¥`;
    } else if (reward.type === 'both') {
        gameState.bananas += reward.bananas;
        gameState.totalBananas += reward.bananas;
        gameState.stars += reward.stars;
        gameState.totalStars += reward.stars;
        rewardText = `–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${reward.bananas} –±–∞–Ω–∞–Ω–æ–≤, +${reward.stars} –∑–≤–µ–∑–¥`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    updateTaskProgress();
    saveGameState();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showPopup(rewardText);
    
    // –ó–≤—É–∫ –∏ –≤–∏–±—Ä–∞—Ü–∏—è
    playSound('task');
    vibrate([100, 30, 100, 30, 100]);
    
    // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
    createConfetti();
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –±–æ–∫—Å–∞
function openBox(type) {
    console.log("–û—Ç–∫—Ä—ã—Ç–∏–µ –±–æ–∫—Å–∞:", type);
    
    let canOpen = false;
    let rewardText = '';
    
    switch(type) {
        case 'simple':
            if (gameState.bananas >= 10) {
                gameState.bananas -= 10;
                canOpen = true;
                
                // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 15 –±–∞–Ω–∞–Ω–æ–≤!';
                    gameState.bananas += 15;
                    gameState.totalBananas += 15;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 2 –∑–≤–µ–∑–¥—ã!';
                    gameState.stars += 2;
                    gameState.totalStars += 2;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Å—Ç–∏–∫–µ—Ä –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–Ω–∞–Ω–æ–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –±–æ–∫—Å–∞!');
                return;
            }
            break;
            
        case 'standard':
            if (gameState.bananas >= 20) {
                gameState.bananas -= 20;
                canOpen = true;
                
                // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 30 –±–∞–Ω–∞–Ω–æ–≤!';
                    gameState.bananas += 30;
                    gameState.totalBananas += 30;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 4 –∑–≤–µ–∑–¥—ã!';
                    gameState.stars += 4;
                    gameState.totalStars += 4;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∏–∫–µ—Ä –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–Ω–∞–Ω–æ–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –±–æ–∫—Å–∞!');
                return;
            }
            break;
            
        case 'premium':
            if (gameState.stars >= 5) {
                gameState.stars -= 5;
                canOpen = true;
                
                // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 50 –±–∞–Ω–∞–Ω–æ–≤!';
                    gameState.bananas += 50;
                    gameState.totalBananas += 50;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 7 –∑–≤–µ–∑–¥!';
                    gameState.stars += 7;
                    gameState.totalStars += 7;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–º–∏—É–º-–±–æ–∫—Å–∞!');
                return;
            }
            break;
            
        case 'mega':
            if (gameState.stars >= 10) {
                gameState.stars -= 10;
                canOpen = true;
                
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 100 –±–∞–Ω–∞–Ω–æ–≤!';
                    gameState.bananas += 100;
                    gameState.totalBananas += 100;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 12 –∑–≤–µ–∑–¥!';
                    gameState.stars += 12;
                    gameState.totalStars += 12;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–¥–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–≥–∞-–±–æ–∫—Å–∞!');
                return;
            }
            break;
            
        case 'special':
            if (gameState.bananas >= 30) {
                gameState.bananas -= 30;
                canOpen = true;
                
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 40 –±–∞–Ω–∞–Ω–æ–≤ –∏ 3 –∑–≤–µ–∑–¥—ã!';
                    gameState.bananas += 40;
                    gameState.stars += 3;
                    gameState.totalBananas += 40;
                    gameState.totalStars += 3;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 5 –∑–≤–µ–∑–¥!';
                    gameState.stars += 5;
                    gameState.totalStars += 5;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–Ω–∞–Ω–æ–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—Å–æ–±–æ–≥–æ –±–æ–∫—Å–∞!');
                return;
            }
            break;
            
        case 'epic':
            if (gameState.stars >= 15) {
                gameState.stars -= 15;
                canOpen = true;
                
                let reward = Math.floor(Math.random() * 3) + 1;
                if (reward === 1) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 150 –±–∞–Ω–∞–Ω–æ–≤!';
                    gameState.bananas += 150;
                    gameState.totalBananas += 150;
                } else if (reward === 2) {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 20 –∑–≤–µ–∑–¥!';
                    gameState.stars += 20;
                    gameState.totalStars += 20;
                } else {
                    rewardText = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ —ç–ø–∏—á–µ—Å–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è Telegram!';
                }
            } else {
                showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —ç–ø–∏—á–µ—Å–∫–æ–≥–æ –±–æ–∫—Å–∞!');
                return;
            }
            break;
    }
    
    if (canOpen) {
        gameState.openedBoxes++;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–º–∏—É–º-–∫–µ–π—Å–∞
        if (type === 'premium' && gameState.taskProgress.task2 === 0) {
            gameState.taskProgress.task2 = 1;
            completeTask(2);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ 5 –±–æ–∫—Å–æ–≤
        if (gameState.openedBoxes >= 5 && gameState.taskProgress.task5 === 0) {
            gameState.taskProgress.task5 = 1;
            completeTask(5);
        }
        
        showPopup(rewardText);
        playSound('box');
        vibrate([50, 30, 100]);
        createConfetti();
        
        updateStats();
        updateTaskProgress();
        saveGameState();
    }
}

// –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π
function inviteFriends() {
    console.log("–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π");
    
    if (tg && tg.initDataUnsafe?.user) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –≤ Telegram
        if (tg.MainButton) {
            tg.MainButton.setText('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏');
            tg.MainButton.show();
            tg.MainButton.onClick(function() {
                if (tg.shareGameScore) {
                    tg.shareGameScore();
                } else if (tg.share) {
                    tg.share();
                }
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
                processFriendInvitation();
                tg.MainButton.hide();
            });
        } else {
            // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
            processFriendInvitation();
        }
    } else {
        // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–≥–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç—É—Ç –±—É–¥–µ—Ç API Telegram)
        processFriendInvitation();
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–≥–∞
function processFriendInvitation() {
    gameState.invitedFriends++;
    gameState.taskProgress.task1 = Math.min(gameState.taskProgress.task1 + 1, 10);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∞ –≤ —Å–ø–∏—Å–æ–∫
    addFriendToList('–î—Ä—É–≥ ' + gameState.invitedFriends);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
    if (gameState.taskProgress.task1 >= 10 && gameState.taskProgress.task1 !== 1) {
        gameState.taskProgress.task1 = 1;
        completeTask(1);
    } else {
        updateTaskProgress();
        saveGameState();
    }
    
    showPopup('–î—Ä—É–≥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω! –ü—Ä–æ–≥—Ä–µ—Å—Å: ' + Math.min(gameState.invitedFriends, 10) + '/10');
    playSound('click');
    vibrate(50);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –≤ —Å–ø–∏—Å–æ–∫
function addFriendToList(name) {
    const friendsList = document.getElementById('friends-list');
    
    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –¥—Ä—É–∑–µ–π", –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –¥—Ä—É–≥
    if (gameState.invitedFriends === 1) {
        friendsList.innerHTML = '';
    }
    
    const friendItem = document.createElement('div');
    friendItem.className = 'friend-item';
    friendItem.innerHTML = `
        <div class="friend-avatar"></div>
        <div>${name}</div>
    `;
    
    friendsList.appendChild(friendItem);
}

// –ö–æ—Ä–º–ª–µ–Ω–∏–µ –º–∏–Ω—å–æ–Ω–∞
function feedMinion() {
    if (gameState.bananas >= 3) {
        gameState.bananas -= 3;
        gameState.taskProgress.task3 = Math.min(gameState.taskProgress.task3 + 1, 5);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ—Ä–º–ª–µ–Ω–∏—è
        const minion = document.querySelector('.big-minion');
        minion.classList.add('feed-animation');
        setTimeout(() => {
            minion.classList.remove('feed-animation');
        }, 1000);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –∫–æ—Ä–º–ª–µ–Ω–∏–µ 5 –º–∏–Ω—å–æ–Ω–æ–≤
        if (gameState.taskProgress.task3 >= 5 && gameState.taskProgress.task3 !== 1) {
            gameState.taskProgress.task3 = 1;
            completeTask(3);
        } else {
            showPopup(`–ú–∏–Ω—å–æ–Ω –Ω–∞–∫–æ—Ä–º–ª–µ–Ω! –ü—Ä–æ–≥—Ä–µ—Å—Å: ${gameState.taskProgress.task3}/5`);
            updateStats();
            updateTaskProgress();
            saveGameState();
        }
        
        playSound('task');
        vibrate(50);
    } else {
        showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–Ω–∞–Ω–æ–≤! –ù—É–∂–Ω–æ 3 –±–∞–Ω–∞–Ω–∞ –¥–ª—è –∫–æ—Ä–º–ª–µ–Ω–∏—è.');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
function updateAchievements() {
    let achievementsList = document.getElementById('achievements-list');
    if (!achievementsList) return;
    
    achievementsList.innerHTML = '';
    
    gameState.achievements.forEach(achievement => {
        let li = document.createElement('li');
        li.textContent = achievement;
        achievementsList.appendChild(li);
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    if (gameState.completedTasks >= 3 && !gameState.achievements.includes('–¢—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫')) {
        gameState.achievements.push('–¢—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫');
        showAchievementNotification('–¢—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫');
    }
    
    if (gameState.totalBananas >= 100 && !gameState.achievements.includes('–ë–∞–Ω–∞–Ω–æ–≤—ã–π –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä')) {
        gameState.achievements.push('–ë–∞–Ω–∞–Ω–æ–≤—ã–π –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä');
        showAchievementNotification('–ë–∞–Ω–∞–Ω–æ–≤—ã–π –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä');
    }
    
    if (gameState.openedBoxes >= 5 && !gameState.achievements.includes('–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏')) {
        gameState.achievements.push('–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏');
        showAchievementNotification('–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏');
    }
    
    if (gameState.invitedFriends >= 5 && !gameState.achievements.includes('–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –º–∏–Ω—å–æ–Ω')) {
        gameState.achievements.push('–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –º–∏–Ω—å–æ–Ω');
        showAchievementNotification('–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –º–∏–Ω—å–æ–Ω');
    }
    
    if (gameState.streak >= 3 && !gameState.achievements.includes('–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∏–≥—Ä–æ–∫')) {
        gameState.achievements.push('–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∏–≥—Ä–æ–∫');
        showAchievementNotification('–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∏–≥—Ä–æ–∫');
    }
    
    if (gameState.level >= 5 && !gameState.achievements.includes('–û–ø—ã—Ç–Ω—ã–π –º–∏–Ω—å–æ–Ω–æ–≤–æ–¥')) {
        gameState.achievements.push('–û–ø—ã—Ç–Ω—ã–π –º–∏–Ω—å–æ–Ω–æ–≤–æ–¥');
        showAchievementNotification('–û–ø—ã—Ç–Ω—ã–π –º–∏–Ω—å–æ–Ω–æ–≤–æ–¥');
    }
    
    if (gameState.achievements.length >= 5 && gameState.taskProgress.task7 === 0) {
        gameState.taskProgress.task7 = 1;
        completeTask(7);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
    if (gameState.totalBananas >= gameState.level * 50 && gameState.totalStars >= gameState.level * 5) {
        gameState.level++;
        showPopup(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${gameState.level}!`);
        playSound('levelUp');
        vibrate([100, 50, 100, 50, 200]);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 3 —É—Ä–æ–≤–Ω—è
        if (gameState.level >= 3 && gameState.taskProgress.task6 === 0) {
            gameState.taskProgress.task6 = 1;
            completeTask(6);
        }
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏
function showAchievementNotification(achievementName) {
    const notification = document.getElementById('achievement-notification');
    document.getElementById('achievement-text').textContent = achievementName;
    
    notification.style.display = 'block';
    
    // –ó–≤—É–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    playSound('achievement');
    vibrate([50, 50, 50, 50, 150]);
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
function showPopup(text) {
    document.getElementById('reward-text').textContent = text;
    const popup = document.getElementById('reward-popup');
    popup.style.display = 'flex';
    setTimeout(() => {
        popup.classList.add('show');
    }, 10);
}

// –ó–∞–∫—Ä—ã—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
function closePopup() {
    const popup = document.getElementById('reward-popup');
    popup.classList.remove('show');
    setTimeout(() => {
        popup.style.display = 'none';
    }, 300);
    
    playSound('click');
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
function createConfetti() {
    const colors = ['#FFD000', '#FFB700', '#FFC400', '#FF8C00', '#FFE066'];
    const confettiCount = 100;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        confetti.style.opacity = Math.random();
        confetti.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
        confetti.style.animation = `
            slideIn ${Math.random() * 2 + 1}s linear forwards,
            fadeIn ${Math.random() * 2 + 1}s ease-out forwards
        `;
        
        document.body.appendChild(confetti);
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            confetti.remove();
        }, 3000);
    }
}

// –ó–∞–ø—É—Å–∫ –º–∏–Ω–∏-–∏–≥—Ä—ã
function startMiniGame() {
    const miniGameContainer = document.getElementById('mini-game-container');
    if (!miniGameContainer) return;
    
    miniGameContainer.style.display = 'flex';
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω—å–æ–Ω–æ–≤ –¥–ª—è –∏–≥—Ä—ã
    const gameField = document.getElementById('mini-game-field');
    gameField.innerHTML = '';
    
    const minionCount = 9;
    let targetMinion = Math.floor(Math.random() * minionCount);
    
    for (let i = 0; i < minionCount; i++) {
        const minionElement = document.createElement('div');
        minionElement.className = 'mini-game-minion';
        minionElement.dataset.index = i;
        
        if (i === targetMinion) {
            minionElement.classList.add('target-minion');
        }
        
        minionElement.addEventListener('click', function() {
            if (i === targetMinion) {
                // –í–µ—Ä–Ω—ã–π –º–∏–Ω—å–æ–Ω
                showPopup('–í—ã –ø–æ–π–º–∞–ª–∏ –Ω—É–∂–Ω–æ–≥–æ –º–∏–Ω—å–æ–Ω–∞! +10 –±–∞–Ω–∞–Ω–æ–≤');
                gameState.bananas += 10;
                gameState.totalBananas += 10;
                playSound('reward');
                vibrate([50, 50, 100]);
                createConfetti();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–±–æ—Ä –±–∞–Ω–∞–Ω–æ–≤
                checkResourceTasks();
            } else {
                // –ù–µ–≤–µ—Ä–Ω—ã–π –º–∏–Ω—å–æ–Ω
                showPopup('–≠—Ç–æ –Ω–µ —Ç–æ—Ç –º–∏–Ω—å–æ–Ω! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                playSound('click');
            }
            
            updateStats();
            saveGameState();
            miniGameContainer.style.display = 'none';
        });
        
        gameField.appendChild(minionElement);
    }
    
    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    document.getElementById('mini-game-instruction').textContent = '–ù–∞–π–¥–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ –º–∏–Ω—å–æ–Ω–∞!';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∏–Ω–∏-–∏–≥—Ä—ã
function closeMiniGame() {
    const miniGameContainer = document.getElementById('mini-game-container');
    if (miniGameContainer) {
        miniGameContainer.style.display = 'none';
    }
    playSound('click');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
function showTip(tipId) {
    const tips = {
        'bananas': '–ë–∞–Ω–∞–Ω—ã - –æ—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞. –ò—Ö –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –±–æ–∫—Å–æ–≤.',
        'stars': '–ó–≤–µ–∑–¥—ã - –ø—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç–∞. –û–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—Å–æ–±—ã—Ö –±–æ–∫—Å–æ–≤.',
        'level': '–í–∞—à —É—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç–µ—Ç, –∫–æ–≥–¥–∞ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ –±–∞–Ω–∞–Ω—ã –∏ –∑–≤–µ–∑–¥—ã. –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–∞—ë—Ç –±–æ–Ω—É—Å—ã!',
        'tasks': '–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.',
        'daily': '–ó–∞—Ö–æ–¥–∏—Ç–µ –≤ –∏–≥—Ä—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –∏ –±–æ–Ω—É—Å—ã –∑–∞ —Å–µ—Ä–∏—é –¥–Ω–µ–π.'
    };
    
    const tipText = tips[tipId] || '–ò–≥—Ä–∞–π—Ç–µ –∏ —Ä–∞–∑–≤–ª–µ–∫–∞–π—Ç–µ—Å—å —Å –º–∏–Ω—å–æ–Ω–∞–º–∏!';
    showPopup(tipText);
}

// –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
function resetProgress() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        localStorage.removeItem('minionsGameState');
        localStorage.removeItem('minionsGameSettings');
        
        // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º, —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—Ç—É–¥–∞
        if (settings.serverSync && settings.userId) {
            fetch(`${SERVER_URL}/delete-progress/${settings.userId}`, {
                method: 'DELETE'
            }).then(() => {
                console.log('–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã');
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
            });
        }
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        location.reload();
    }
}

// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤
function preloadSounds() {
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–≤—É–∫–∏
    Object.values(sounds).forEach(sound => {
        sound.load();
    });
}

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–º–ª–µ–Ω–∏—è –º–∏–Ω—å–æ–Ω–∞
    const feedButton = document.getElementById('feed-minion-btn');
    if (feedButton) {
        feedButton.addEventListener('click', feedMinion);
    }
    
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∏–Ω–∏-–∏–≥—Ä—ã
    const miniGameButton = document.getElementById('start-mini-game');
    if (miniGameButton) {
        miniGameButton.addEventListener('click', startMiniGame);
    }
    
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–Ω–∏-–∏–≥—Ä—ã
    const closeMiniGameButton = document.getElementById('close-mini-game');
    if (closeMiniGameButton) {
        closeMiniGameButton.addEventListener('click', closeMiniGame);
    }
    
    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const resetButton = document.getElementById('reset-progress');
    if (resetButton) {
        resetButton.addEventListener('click', resetProgress);
    }
    
    // –ö–Ω–æ–ø–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    document.querySelectorAll('.tip-button').forEach(button => {
        button.addEventListener('click', function() {
            showTip(this.dataset.tip);
            playSound('click');
        });
    });
    
    // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å
    const spinWheelButton = document.getElementById('spin-wheel-btn');
    if (spinWheelButton) {
        spinWheelButton.addEventListener('click', spinRewardWheel);
    }
}

// –í—Ä–∞—â–µ–Ω–∏–µ –∫–æ–ª–µ—Å–∞ –Ω–∞–≥—Ä–∞–¥
function spinRewardWheel() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –≤—Ä–∞—â–∞—Ç—å (—Ä–∞–∑ –≤ –¥–µ–Ω—å)
    const today = new Date().toDateString();
    if (gameState.lastWheelSpin === today) {
        showPopup('–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞.');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
    const wheel = document.getElementById('reward-wheel');
    if (!wheel) return;
    
    playSound('box');
    vibrate([50, 50, 50, 50, 100]);
    
    // –°–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä–æ—Ç–æ–≤ –ø–ª—é—Å —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ç–æ—Ä
    const sectors = 8; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—Ç–æ—Ä–æ–≤ –Ω–∞ –∫–æ–ª–µ—Å–µ
    const rotations = 5; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤
    const sector = Math.floor(Math.random() * sectors);
    const angle = rotations * 360 + (sector * (360 / sectors));
    
    wheel.style.transition = 'transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)';
    wheel.style.transform = `rotate(${angle}deg)`;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–ª–µ—Å–∞
    setTimeout(() => {
        let reward;
        
        // –ù–∞–≥—Ä–∞–¥—ã –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º (–æ—Ç 0 –¥–æ 7)
        switch(sector) {
            case 0: // 10 –±–∞–Ω–∞–Ω–æ–≤
                reward = { type: 'bananas', amount: 10 };
                break;
            case 1: // 20 –±–∞–Ω–∞–Ω–æ–≤
                reward = { type: 'bananas', amount: 20 };
                break;
            case 2: // 2 –∑–≤–µ–∑–¥—ã
                reward = { type: 'stars', amount: 2 };
                break;
            case 3: // 50 –±–∞–Ω–∞–Ω–æ–≤
                reward = { type: 'bananas', amount: 50 };
                break;
            case 4: // 5 –∑–≤–µ–∑–¥
                reward = { type: 'stars', amount: 5 };
                break;
            case 5: // 30 –±–∞–Ω–∞–Ω–æ–≤
                reward = { type: 'bananas', amount: 30 };
                break;
            case 6: // 3 –∑–≤–µ–∑–¥—ã
                reward = { type: 'stars', amount: 3 };
                break;
            case 7: // –î–∂–µ–∫–ø–æ—Ç: 100 –±–∞–Ω–∞–Ω–æ–≤ –∏ 10 –∑–≤–µ–∑–¥
                reward = { type: 'both', bananas: 100, stars: 10 };
                break;
        }
        
        // –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
        let rewardText = '';
        
        if (reward.type === 'bananas') {
            gameState.bananas += reward.amount;
            gameState.totalBananas += reward.amount;
            rewardText = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${reward.amount} –±–∞–Ω–∞–Ω–æ–≤!`;
        } else if (reward.type === 'stars') {
            gameState.stars += reward.amount;
            gameState.totalStars += reward.amount;
            rewardText = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${reward.amount} –∑–≤–µ–∑–¥!`;
        } else if (reward.type === 'both') {
            gameState.bananas += reward.bananas;
            gameState.totalBananas += reward.bananas;
            gameState.stars += reward.stars;
            gameState.totalStars += reward.stars;
            rewardText = `–î–∂–µ–∫–ø–æ—Ç! +${reward.bananas} –±–∞–Ω–∞–Ω–æ–≤ –∏ +${reward.stars} –∑–≤–µ–∑–¥!`;
            
            // –û—Å–æ–±—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –¥–∂–µ–∫–ø–æ—Ç–∞
            createConfetti();
            playSound('achievement');
            vibrate([100, 50, 100, 50, 200, 50, 200]);
        }
        
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –≤—Ä–∞—â–µ–Ω–∏—è
        gameState.lastWheelSpin = today;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        updateStats();
        checkResourceTasks();
        saveGameState();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        showPopup(rewardText);
        
    }, 4000); // –ü–æ–¥–æ–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Ä–∞—â–µ–Ω–∏—è
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω");
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤
    preloadSounds();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        const sectionId = item.getAttribute('data-section');
        if (sectionId) {
            item.addEventListener('click', function() {
                playSound('click');
                vibrate(30);
                showSection(sectionId);
            });
        }
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    init();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.onload = function() {
    console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
};
